
var tableAddPerfis='<table class="box-table-a" width="100%"><thead><tr><th width="15%">Avatar</th><th width="30%">Nome</th><th width="55%">Email</th></tr></thead><tbody id="addPerfis"></tbody></table>';var wCompara1,wCompara2;$("#btn_alterar").on("click",function(){if((lstIdProcesso==2||lstIdProcesso==3||lstIdProcesso==10)&&!lstDataFim){swal({title:"Tem certeza que deseja alterar?",text:"Esta contagem j&aacute; foi validada interna e/ou externamente, caso altere, a contagem iniciar&aacute; a partir do processo de <strong>Elabora&ccedil;&atilde;o</strong> e a a&ccedil;&atilde;o n&atilde;o pode ser desfeita.",type:"warning",html:true,showCancelButton:true,cancelButtonText:"Não, obrigado",confirmButtonColor:"#DD6B55",confirmButtonText:"Sim, por favor",closeOnConfirm:true},function(a){if(a){atualizarHistoricoTpoAlteracao()}else{return false}})}else{exibeContagemAlteracao()}});$(".btn-opc").on("click",function(){var b=$(this).val();$.post("/pf/DIM.Gateway.php",{i:lstIdContagem,arq:20,tch:1,sub:-1,dlg:1},function(c){var a;switch(Number(c.id)){case 1:case 2:case 3:case 4:case 9:a=0;break;case 5:a=1;break;case 6:a=2;break;case 7:return false;break}self.location.href="/pf/DIM.Gateway.php?arq="+a+"&tch=2&sub=-1&dlg=1&ac="+b+"&ab="+c.id+"&id="+lstIdContagem+"&rot="+c.id_roteiro},"json")});$(".btn-fa").on("click",function(){var d=$(this).html();var c=$(this).val();var e=d.search("interna")>0?"ai":"ae";var f=validaEmail(emailLogado)?emailLogado:false;c===e&&f&&(btnFAI||btnFAE)?validarContagem($(this).get(0).id,lstIdContagem,c,null,e,f,false):gravaLogAuditoria(emailLogado,userRole,(e==="ai"?"finalizar-a-interna;":"finalizar-a-externa")+("000000000"+lstIdContagem).slice(-9));if(!(btnFAI||btnFAE)){$(this).prop("disabled",true)}});$("#btn_baseline_estimativa").on("click",function(){$.post("/pf/DIM.Gateway.php",{arq:89,tch:0,sub:-1,dlg:0,idc:lstIdContagem},function(a){if(a.sucesso){swal({title:"Informação",text:"A baseline de estimativa foi salva com sucesso!",type:"success",html:true,closeOnConfirm:true})}},"json")});$("#btn_privacidade").on("change",function(){if(isAtualizarPrivacidade){var a=$(this).prop("checked");$.post("/pf/DIM.Gateway.php",{i:lstIdContagem,p:a?1:0,arq:13,tch:0,sub:-1,dlg:1},function(b){if(b.msg){$("#span-privacidade").animate({opacity:0},function(){$(this).html("Privacidade definida com sucesso!").animate({opacity:1}).animate({opacity:0},3000)});$("#priv-"+lstIdContagem).html(a?'<i class="fa fa-ban"></i>&nbsp;&nbsp;':'<i class="fa fa-circle-thin"></i>&nbsp;&nbsp;')}},"json")}});$("#btn_atualizar_baseline").on("click",function(){swal({title:"Tem certeza que deseja atualizar a Baseline com esta contagem?",text:"Ao atualizar uma baseline atrav&eacute;s de uma contagem de projeto a a&ccedil;&atilde;o n&atilde;o poder&aacute; ser desfeita e a contagem n&atilde;o poder&aacute; mais ser alterada.",type:"warning",html:true,showCancelButton:true,cancelButtonText:"Não, obrigado",confirmButtonColor:"#DD6B55",confirmButtonText:"Sim, por favor",closeOnConfirm:true},function(a){if(a){atualizarBaselineContagem(lstIdContagem)}else{return false}})});$("#btn_finalizar").on("click",function(){btnFIN?finalizarContagem(lstIdContagem):gravaLogAuditoria(emailLogado,userRole,"finalizar-contagem-"+("000000000"+lstIdContagem).slice(-9));if(!(btnFIN)){$(this).prop("disabled",true)}});$("#btn-pdf").on("click",function(){window.open("/pf/DIM.Gateway.php?arq=62&tch=0&sub=3&dlg=1&i="+lstIdContagem)});$("#btn-html").on("click",function(){window.open("/pf/DIM.Gateway.php?arq=61&tch=0&sub=3&dlg=1&i="+lstIdContagem+"&p=html")});$("#btn-xls").on("click",function(){window.open("/pf/DIM.Gateway.php?arq=63&tch=0&sub=3&dlg=1&t=xls&i="+lstIdContagem)});$("#btn-ods").on("click",function(){window.open("/pf/DIM.Gateway.php?arq=63&tch=0&sub=3&dlg=1&t=ods&i="+lstIdContagem)});$("#btn-xlsx").on("click",function(){window.open("/pf/DIM.Gateway.php?arq=63&tch=0&sub=3&dlg=1&t=xlsx&i="+lstIdContagem)});$("#fechar-funcoes-perfil").on("click",function(){isAtualizarPrivacidade=false;lstIdProcesso="";lstDataFim="";lstIdCliente="";lstIdContagem="";$("#btn_privacidade").bootstrapToggle("enable");$("#addPerfis").empty()});$(".btn-acoes").on("click",function(){var c=($(this).val()).split(";");var b=c[0];var a=c[1];$("#log-tabela").empty().html(tableAddPerfis);$.post("/pf/DIM.Gateway.php",{escopo:b,ic:lstIdCliente,arq:38,tch:1,sub:-1,dlg:1},function(d){for(x=0;x<d.length;x++){adicionarLinhasPerfis(d[x],b,a)}},"json")});$("#comparar-contagens").on("change",function(){if($("#realizar-analise-fiscal").prop("checked")){$("#realizar-analise-fiscal").prop("checked",false)}});$("#realizar-analise-fiscal").on("change",function(){if($("#comparar-contagens").prop("checked")){$("#comparar-contagens").prop("checked",false)}});$("#faturar").on("change",function(){$("#btn-faturar").prop("disabled",!($(this).prop("checked")));$("#mes-ano-faturamento").prop("disabled",!($(this).prop("checked"))).val("");zeraSelecionadaFaturar(false)});$("#btn-faturar").on("click",function(){$(this).prop("disabled",true);$("#i-btn-faturar").removeClass("fa-check-square-o").addClass("fa-refresh fa-spin");$("#s-btn-faturar").html("&nbsp;Aguarde...");var a=$("#mes-ano-faturamento").val().split("-");var d=Number(a[0]);var b=Number(a[1]);var c=$("#mes-ano-faturamento").val();if(b.length<4||d<1||d>12){swal({title:"Alerta",html:true,type:"error",text:"M&ecirc;s / Ano do faturamento est&aacute; incorreto."},function(){$("#i-btn-faturar").removeClass("fa-refresh fa-spin").addClass("fa-check-square-o");$("#s-btn-faturar").html("&nbsp;Gerar faturamento");$("#btn-faturar").prop("disabled",false)})}else{if(arrFaturar.length<1){swal({title:"Alerta",html:true,type:"error",text:"Por favor, selecione ao menos uma contagem para realizar o faturamento"},function(){$("#i-btn-faturar").removeClass("fa-refresh fa-spin").addClass("fa-check-square-o");$("#s-btn-faturar").html("&nbsp;Gerar faturamento");$("#btn-faturar").prop("disabled",false)})}else{$.post("/pf/DIM.Gateway.php",{arq:81,tch:0,sub:-1,dlg:0,fat:arrFaturar,maf:c},function(e){if(e.sucesso){swal({title:"Informa&ccedil;&atilde;o",html:true,type:"success",text:"O faturamento foi enviado com sucesso. Aguarde um email informando o local onde voc&ecirc; far&aacute; o <i>download</i> do arquivo."},function(){tableLista.ajax.reload();$.post("/pf/DIM.Gateway.php",{arq:82,tch:0,sub:-1,dlg:0,fat:arrFaturar,maf:c});$("#i-btn-faturar").removeClass("fa-refresh fa-spin").addClass("fa-check-square-o");$("#s-btn-faturar").html("&nbsp;Gerar faturamento");$("#mes-ano-faturamento").val("");$("#faturar").prop("checked",false);zeraSelecionadaFaturar(true)})}else{swal({title:"Alerta",html:true,type:"error",text:"Houve erro ao processar o faturamento, por favor, verifique junto ao administrador."})}},"json")}}});$("#form-modal-comparar-contagens").on("hide.bs.modal",function(){$(TRCompara).parent().parent().parent().find("td:lt(13)").css("background-color","");comparaID1=0;comparaID2=0;$("#comparar-id-1").html("0000000");$("#comparar-id-2").html("0000000");CKEDITOR.instances.analiseFiscalContrato.setData("")});function adicionarLinhasPerfis(h,g,a){var e=$("#addPerfis").get(0);var f=e.insertRow(-1);var d=f.insertCell(0);var c=f.insertCell(1);var b=f.insertCell(2);d.innerHTML='<img id="img-'+h.user_id+'" onclick="selecionaPerfil(\''+h.user_email+"', '"+g+"', '"+a+'\');" class="img-circle img-responsive" style="width:64px; height:64px; cursor:default; cursor:pointer;">';c.innerHTML='<font style="font-family:arial; font-size:13px; font-weight:bold; text-shadow: 1px 0px #fff;">'+h.user_complete_name+'</font><br /><font style="color: #999"><i class="fa fa-phone-square"></i>&nbsp;'+(h.telefone_celular!==null?h.telefone_celular:"-")+'<br /><i class="fa fa-phone"></i>&nbsp;'+(h.telefone_fixo!==null?h.telefone_fixo:"-")+"</font>";b.innerHTML='<font style="font-size:9px; color:#999; text-shadow: 1px 0px #fff;">Principal<br /></font><a href="mailto:'+h.user_email+'">'+h.user_email+'</a><br /><font style="font-size:9px; color:#999; text-shadow: 1px 0px #fff;">Alternativo<br /></font>'+(h.email_alternativo!==null?'<a href="mailto:'+h.email_alternativo+'">'+h.email_alternativo+"</a>":"-");consultaGravatar(h.user_email,"#img-"+h.user_id)}function selecionaPerfil(b,d,a){var e;var c;switch(d){case"vi":e="a Valida&ccedil;&atilde;o Interna";c=2;break;case"ve":e="a Valida&ccedil;&atilde;o Externa";c=3;break;case"ai":e="a Auditoria Interna";c=4;break;case"ae":e="a Auditoria Externa";c=5;break}swal({title:"Tem certeza que deseja enviar a contagem para <strong>"+e+"</strong>?",text:"Ao enviar para este processo a a&ccedil;&atilde;o n&atilde;o poder&aacute; ser desfeita.",type:"warning",html:true,showCancelButton:true,cancelButtonText:"Não, obrigado",confirmButtonColor:"#DD6B55",confirmButtonText:"Sim, por favor",closeOnConfirm:false},function(f){if(f){atualizaProcessoValidacao(c,lstIdContagem,b,false,a);$("#form_modal_funcoes_perfil_contagem").modal("toggle");$("#addPerfis").empty()}else{return false}})}function exibeContagemAlteracao(){$.post("/pf/DIM.Gateway.php",{i:lstIdContagem,arq:20,tch:1,sub:-1,dlg:1},function(b){var a;switch(Number(b.id)){case 1:case 2:case 3:case 4:case 9:a=0;break;case 5:a=1;break;case 6:a=2;break}self.location.href="/pf/DIM.Gateway.php?arq="+a+"&tch=2&sub=-1&dlg=1&ac=al&ab="+b.id+"&id="+lstIdContagem+(b.isContagemAuditoria==1?"&aud=1":"")+"&rot="+idRoteiro},"json")}function atualizarHistoricoTpoAlteracao(){$.post("/pf/DIM.Gateway.php",{i:lstIdContagem,arq:12,tch:0,sub:-1,dlg:1},function(a){exibeContagemAlteracao()},"json")}function verificaAutorizacao(d,c){lstIdContagem=d;compararContagens=$("#comparar-contagens").prop("checked");realizarAnaliseFiscal=$("#realizar-analise-fiscal").prop("checked");doisMonitores=$("#dois-monitores").prop("checked");faturar=$("#faturar").prop("checked");if(compararContagens){if(comparaID1==0){comparaID1=d;TRCompara=$(c);$("#comparar-id-1").html(("0000000"+d).slice(-7));$("#comparar-id-2").html("0000000");$(c).parent().parent().parent().find("td:lt(13)").css("background-color","rgba(168, 178, 213, 1)")}else{if(comparaID2==0){comparaID2=d;if(comparaID2==comparaID1){$(TRCompara).parent().parent().parent().find("td:lt(13)").css("background-color","");comparaID1=0;comparaID2=0;$("#comparar-id-1").html("0000000")}else{$("#comparar-id-2").html(("0000000"+d).slice(-7));if(doisMonitores){wCompara1=window.open("/pf/DIM.Gateway.php?arq=90&tch=0&sub=3&dlg=1&i="+comparaID1+"&i2="+comparaID2+"&p=html&cp=&dm","_blank","toolbar=0,location=0,menubar=0");wCompara2=window.open("/pf/DIM.Gateway.php?arq=90&tch=0&sub=3&dlg=1&i="+comparaID2+"&p=html&cp=","_blank","toolbar=0,location=0,menubar=0")}else{$("#col-compara-1").remove();$("#col-compara-2").remove();$("#div-compara-contagem").append('<div class="col-md-6 scroll" id="col-compara-1" style="min-height: 630px; max-height: 630px; overflow-x: hidden; overflow-y: scroll;"></div>');$("#div-compara-contagem").append('<div class="col-md-6 scroll" id="col-compara-2" style="min-height: 630px; max-height: 630px; overflow-x: hidden; overflow-y: scroll;"></div>');$.get("/pf/DIM.Gateway.php?arq=90&tch=0&sub=3&dlg=1&i="+comparaID1+"&i2="+comparaID2+"&p=html&cp=",function(e){$("#col-compara-1").html(e)});$.get("/pf/DIM.Gateway.php?arq=90&tch=0&sub=3&dlg=1&i="+comparaID2+"&p=html&cp=",function(e){$("#col-compara-2").html(e)});$("#modal-dialog-comparar-contagens").addClass("modal-lg");$("#form-modal-comparar-contagens").modal("toggle");$.post("/pf/DIM.Gateway.php",{idContagem1:comparaID1,idContagem2:comparaID2,tipo:0,arq:90,tch:1,sub:-1,dlg:0},function(e){DIMCKEditor.setData(e.analise)},"json");$("#col-compara-1").on("scroll",function(){$("#col-compara-2").scrollTop($(this).scrollTop())})}}}}}else{if(realizarAnaliseFiscal){comparaID1=d;comparaID2=0;if(doisMonitores){window.open("/pf/DIM.Gateway.php?arq=90&tch=0&sub=3&dlg=1&i="+d+"&p=html&cp=&an=","_blank","toolbar=0,location=0,menubar=0")}else{$("#col-compara-1").remove();$("#col-compara-2").remove();$("#div-compara-contagem").append('<div class="col-md-12 scroll" id="col-compara-1" style="min-height: 630px; max-height: 630px; overflow-x: hidden; overflow-y: scroll;"></div>');$.get("/pf/DIM.Gateway.php?arq=90&tch=0&sub=3&dlg=1&i="+d+"&p=html&cp=&an=",function(e){$("#col-compara-1").html(e)});$("#modal-dialog-comparar-contagens").removeClass("modal-lg");$("#form-modal-comparar-contagens").modal("toggle");$.post("/pf/DIM.Gateway.php",{idContagem1:comparaID1,idContagem2:comparaID2,tipo:1,arq:90,tch:1,sub:-1,dlg:0},function(e){DIMCKEditor.setData(e.analise)},"json")}}else{if(faturar){if($(c).parent().parent().parent().hasClass("tr-selecionada")){$(c).parent().parent().parent().removeClass("tr-selecionada").find("td:lt(13)").css("background-color","");selecionadaFaturar(d)}else{var b=isFornecedor?"fauF":"fauE";var a=$(c).parent().parent().parent().find("td:eq(3)").parent().find("div").hasClass(b);if(a){$(c).parent().parent().parent().addClass("tr-selecionada").find("td:lt(13)").css("background-color","rgba(168, 178, 213, 1)");selecionadaFaturar(d)}else{swal({title:"Alerta",html:true,type:"error",text:"Por favor, selecione apenas as contagens com FATURAMENTO AUTORIZADO e/ou ser voc&ecirc; &eacute; um GESTOR, selecione apenas as contagens de sua Empresa. As contagens de Fornecedores devem ser faturadas por seus respectivos gestores."})}}}else{$("#id").val(lstIdContagem);$("#id_contagem").html(("0000000"+d).slice(-7));$.post("/pf/DIM.Gateway.php",{i:d,arq:51,tch:1,sub:-1,dlg:1},function(e){$("#form_modal_funcoes_perfil_contagem").modal("toggle");$("#btn_alterar").prop("disabled",!e.btn_alterar).removeClass("btn-success").addClass(e.btn_alterar?"btn-success":"btn-default");$("#btn_revisar").prop("disabled",!e.btn_revisar).removeClass("btn-success").addClass(e.btn_revisar?"btn-success":"btn-default");$("#btn_copiar").prop("disabled",!e.btn_copiar).removeClass("btn-success").addClass(e.btn_copiar?"btn-success":"btn-default");$("#btn_editar").prop("disabled",!e.btn_editar).removeClass("btn-success").addClass(e.btn_editar?"btn-success":"btn-default");$("#btn_excluir").prop("disabled",!e.btn_excluir).removeClass("btn-warning").addClass(e.btn_excluir?"btn-warning":"btn-default");$("#btn_finalizar").prop("disabled",!e.btn_finalizar).removeClass("btn-sucesss").addClass(e.btn_finalizar?"btn-sucess":"btn-default");$("#btn_baseline_estimativa").prop("disabled",!e.btn_baseline_estimativa).removeClass("btn-success").addClass(e.btn_baseline_estimativa?"btn-success":"btn-default");$("#btn_atualizar_baseline").prop("disabled",!e.btn_atualizar_baseline).removeClass("btn-success").addClass(e.btn_atualizar_baseline?"btn-success":"btn-default");$("#btn_visualizar").prop("disabled",!e.btn_visualizar).removeClass("btn-success").addClass(e.btn_visualizar?"btn-success":"btn-default");$("#btn_alterar_validador_interno").prop("disabled",!e.btn_alterar_validador_interno).removeClass("btn-success").addClass(e.btn_alterar_validador_interno?"btn-success":"btn-default");$("#btn_alterar_validador_externo").prop("disabled",!e.btn_alterar_validador_externo).removeClass("btn-success").addClass(e.btn_alterar_validador_externo?"btn-success":"btn-default");$("#btn_alterar_gerente_projeto").prop("disabled",!e.btn_alterar_gerente_projeto).removeClass("btn-success").addClass(e.btn_alterar_gerente_projeto?"btn-success":"btn-default");$("#btn_finalizar_auditoria_interna").prop("disabled",!e.btn_finalizar_auditoria_interna).removeClass("btn-success").addClass(e.btn_finalizar_auditoria_interna?"btn-success":"btn-default");$("#btn_finalizar_auditoria_externa").prop("disabled",!e.btn_finalizar_auditoria_externa).removeClass("btn-success").addClass(e.btn_finalizar_auditoria_externa?"btn-success":"btn-default");$("#btn_privacidade").bootstrapToggle(e.privacidade==0?"off":"on");$("#btn_privacidade").bootstrapToggle(isFornecedor?"disable":(e.btn_privacidade?"enable":"disable"));$("#btn_validar_interno").prop("disabled",!e.btn_validar_interno).removeClass("btn-success").addClass(e.btn_validar_interno?"btn-success":"btn-default");$("#btn_validar_externo").prop("disabled",!e.btn_validar_externo).removeClass("btn-success").addClass(e.btn_validar_externo?"btn-success":"btn-default");$("#btn_auditar_interno").prop("disabled",!e.btn_auditar_interno).removeClass("btn-success").addClass(e.btn_auditar_interno?"btn-success":"btn-default");$("#btn_auditar_externo").prop("disabled",!e.btn_auditar_externo).removeClass("btn-success").addClass(e.btn_auditar_externo?"btn-success":"btn-default");$("#btn_empresa").prop("disabled",!e.btn_empresa).removeClass("btn-success").addClass(e.btn_empresa?"btn-success":"btn-default");$("#btn_diretorio").prop("disabled",!e.btn_diretorio).removeClass("btn-success").addClass(e.btn_diretorio?"btn-success":"btn-default");$("#btn_orgao").prop("disabled",!e.btn_orgao).removeClass("btn-success").addClass(e.btn_orgao?"btn-success":"btn-default");$("#btn-pdf").prop("disabled",!e.btn_pdf).removeClass("btn-success").addClass(e.btn_pdf?"btn-success":"btn-default");$("#btn-html").prop("disabled",!e.btn_html).removeClass("btn-success").addClass(e.btn_html?"btn-success":"btn-default");$("#btn-ods").prop("disabled",!e.btn_ods).removeClass("btn-success").addClass(e.btn_ods?"btn-success":"btn-default");$("#btn-xls").prop("disabled",!e.btn_xls).removeClass("btn-success").addClass(e.btn_xls?"btn-success":"btn-default");$("#btn-xlsx").prop("disabled",!e.btn_xlsx).removeClass("btn-success").addClass(e.btn_xlsx?"btn-success":"btn-default");$("#btn-zip").prop("disabled",!e.btn_zip).removeClass("btn-success").addClass(e.btn_zip?"btn-success":"btn-default");$("#btn_colaborar").prop("disabled",!e.btn_colaborar).removeClass("btn-success").addClass(e.btn_colaborar?"btn-success":"btn-default");$("#btn_validador_externo").prop("disabled",!e.btn_validador_externo).removeClass("btn-success").addClass(e.btn_validador_externo?"btn-success":"btn-default");$("#btn_auditor_interno").prop("disabled",!e.btn_auditor_interno).removeClass("btn-success").addClass(e.btn_auditor_interno?"btn-success":"btn-default");$("#btn_auditor_externo").prop("disabled",!e.btn_auditor_externo).removeClass("btn-success").addClass(e.btn_auditor_externo?"btn-success":"btn-default");lstIdProcesso=e.id_processo;lstDataFim=e.data_fim;lstIdCliente=e.id_cliente;isAtualizarPrivacidade=true;idRoteiro=e.id_roteiro;btnFAI=e.btn_finalizar_auditoria_interna;btnFAE=e.btn_finalizar_auditoria_externa;btnFIN=e.btn_finalizar},"json")}}}}function fe(a){if($(a).val()==="e"){$.post("/pf/DIM.Gateway.php",{i:lstIdContagem,arq:27,tch:1,sub:-1,dlg:1},function(b){if(b.sucesso){swal({title:"Informa&ccedil;&atilde;o",text:b.msg,type:"success",html:true,confirmButtonText:"Ok, obrigado!"});$("[data-original-title]").popover("hide");$("#form_modal_funcoes_perfil_contagem").modal("hide");var c=self.location.href;if(c.indexOf("DIM.Gateway.php?arq=3")>0){arq=32;tch=1;sub=-1;dlg=1;p="";v="";tableLista.ajax.reload();pushState(DIR_APP+"pf/DIM.Gateway.php?arq=3&tch=2&sub=-1&dlg=1","Dimension - M&eacute;tricas",DIR_APP+"pf/DIM.Gateway.php?arq=3&tch=2&sub=-1&dlg=1")}else{self.location.href="/pf/DIM.Gateway.php?arq=3&tch=2&sub=-1&dlg=1&p=&v="}$("#navbar-listar-tarefas-pendentes").html(b.qtd)}else{swal({title:"Informa&ccedil;&atilde;o",text:b.msg,type:"warning",html:true,confirmButtonText:"Ok, vou verificar!"})}},"json")}else{$("[data-original-title]").popover("hide")}};